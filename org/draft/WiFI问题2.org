
* 问题描述
   设备当GO时， p2p virtual interface 启动时，有时会出现Device or Resource is busy
* 问题分析
   p2p 协商成功后，会创建一个virtual interface, 即 调用
   =wpa_driver_nl80211_if_add= ， 在该函数中，会调用
   =linux_set_iface_flags= 将虚拟接口设置为UP状态， 查看该函数的代码如
   下：
   [[./images/2016/2016031106.png]]
   在下这个命令时，出现上述错误。 kernel中处理该命令的函数为：
   =devinet_ioctl=
   进一步追下去，在该函数中： =__dev_change_flags= 有如下代码：
   [[./images/2016/2016031107.png]]
   UP会对应 =__dev_open= 函数。 这个函数会调用driver注册的打开网络接口
   的回调函数。如下代码所示 ：
   [[./images/2016/2016031108.png]]
   从上述代码也可以看到，在打开设备之前，会发送一个 =NETDEV_PRE_UP= 通
   知链消息。 在 =cfg80211_netdev_notifier_call= 函数中，会处理该消息：
   这个逻辑主要是一些Sanity Check，即此时能不能打开该网络接口。
   [[./images/2016/2016031109.png]]
   最重要的处理函数是 =cfg80211_can_use_iftype_chan= ，在这个函数中会
   分析当前打开网络接口是否有问题。
* 解决方法
  通过对上述代码的分析，结合driver的Log，做出了如下的修改：
  [[./images/2016/2016031110.png]]
